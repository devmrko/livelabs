# 🏗️ LiveLabs AI Assistant - 서비스 아키텍처

## 📋 개요
LiveLabs AI Assistant는 자연어 처리, 시맨틱 검색, 사용자 스킬 진도 추적을 결합한 다단계 AI 워크플로우를 통해 개인화된 워크샵 추천을 제공하는 종합적인 시스템입니다. Oracle Database 23ai의 SELECT AI와 벡터 검색 기능을 활용하여 4,000+ 워크샵에서 최적의 학습 경로를 제안합니다.

## 📁 프로젝트 구조

```
livelabs/
├── MCP/                              # 🔌 MCP 서비스 (JSON-RPC & REST APIs)
│   ├── __init__.py
│   ├── rest_livelabs_nl_query.py               # REST API - NL to SQL
│   ├── rest_livelabs_semantic_search.py        # REST API - 벡터 검색
│   └── rest_livelabs_user_skills_progression.py # REST API - 스킬 추적
├── utils/                            # 🛠️ 유틸리티 모듈
│   ├── __init__.py
│   ├── ai_reasoner.py               # AI 추론 엔진
│   ├── genai_client.py              # Oracle GenAI 클라이언트
│   ├── mongo_utils.py               # MongoDB 유틸리티
│   ├── oci_embedding.py             # OCI 임베딩 서비스
│   ├── oracle_db.py                 # Oracle 데이터베이스 매니저
│   ├── selenium_utils.py            # Selenium 웹 드라이버 유틸리티
│   ├── vector_search.py             # 벡터 검색 엔진
│   └── workshop_parser.py           # 워크샵 파싱 유틸리티
├── config/                           # ⚙️ 설정 파일
│   └── services.json                # 서비스 설정
├── doc/                              # 📚 문서
│   ├── MCP_SETUP_GUIDE.md
│   ├── README_MCP.md
│   └── README_Streamlit.md
├── test/                             # 🧪 테스트 스크립트
│   ├── test_ai_workshop_planner.py
│   ├── test_batch_embedding.py
│   ├── test_direct_mcp.py
│   ├── test_embedding_text_prep.py
│   ├── test_enhanced_workflow.py
│   ├── test_freeform_nl.py
│   ├── test_mcp_connection.py
│   ├── test_mcp_direct.py
│   ├── test_mcp_simple.py
│   ├── test_mongo_db.py
│   ├── test_new_apis.py
│   ├── test_nl_query.py
│   ├── test_nl_query_mcp_client.py
│   ├── test_no_fabrication.py
│   ├── test_oracle_db.py
│   ├── test_rest_apis.py
│   ├── test_semantic_search_mcp_client.py
│   ├── test_single_workshop.py
│   ├── test_streamlit_workflow.py
│   ├── test_user_skills_mcp_client.py
│   └── test_workflow.py
├── logs/                             # 📝 서비스 로그 (타임스탬프)
├── pids/                             # 🔢 프로세스 ID 파일
├── streamlit_livelabs_rest_app.py    # 🌐 메인 Streamlit 애플리케이션
├── workshop_ai_enhancer.py           # 🤖 워크샵 AI 강화기
├── workshop_content_extractor.py     # 📄 워크샵 콘텐츠 추출기
├── workshop_data_importer.py         # 📥 워크샵 데이터 임포터
├── workshop_embedding_pipeline.py    # 🔗 워크샵 임베딩 파이프라인
├── workshop_text_scraper_refactored.py # 🕷️ 워크샵 텍스트 스크래퍼
├── start_services.sh                 # 🚀 서비스 시작 스크립트
├── stop_services.sh                  # 🛑 서비스 종료 스크립트
├── requirements.txt                  # 📦 통합 의존성
├── LIVELABS_DATABASE_SCHEMA.md       # 🗃️ 데이터베이스 스키마
├── EXAMPLES.md                       # 💡 사용 예시
└── README.md                         # 📖 메인 문서
```

## 🔧 핵심 서비스

### 1. 🔍 시맨틱 검색 서비스 (포트 8001)
**파일:** `MCP/rest_livelabs_semantic_search.py`

- **목적**: 임베딩을 사용한 벡터 기반 워크샵 검색
- **기술**: Oracle Vector Database 23ai, Cohere 임베딩 (cohere.embed-v4.0)
- **주요 기능**:
  - 워크샵 콘텐츠 전반에 걸친 시맨틱 유사도 검색
  - COSINE 거리 계산 (VECTOR 데이터 타입 활용)
  - 워크샵 메타데이터 검색 및 필터링
  - 검색 통계 및 상태 모니터링
  - 4,000+ 워크샵에서 실시간 검색

**API 엔드포인트:**
- `POST /search` - 시맨틱 워크샵 검색
- `GET /stats` - 검색 통계
- `GET /health` - 서비스 상태 확인
- `GET /mcp/tools` - MCP 도구 목록

**데이터베이스 테이블:**
- `ADMIN.LIVELABS_WORKSHOPS2` - 워크샵 메타데이터 및 벡터 임베딩
- `COHERE4_EMBEDDING VECTOR(1536, FLOAT32)` - 시맨틱 검색용 벡터

### 2. 💬 자연어 쿼리 서비스 (포트 8002)
**파일:** `MCP/rest_livelabs_nl_query.py`

- **목적**: Oracle SELECT AI를 사용한 자연어-SQL 변환
- **기술**: Oracle Database 23ai SELECT AI, OpenAI/Cohere LLM
- **주요 기능**:
  - 사용자 스킬 및 학습 이력 자연어 쿼리
  - 동적 SQL 생성 및 실행
  - AI 기반 쿼리 최적화
  - 안전한 SQL 이스케이핑
  - 한국어 자연어 처리

**API 엔드포인트:**
- `POST /users/search/nl` - 자연어 사용자 쿼리
- `GET /health` - 서비스 상태 확인
- `GET /mcp/tools` - MCP 도구 목록

**AI 프로필 설정:**
```sql
CREATE_PROFILE('DISCOVERYDAY_AI_PROFILE', {
  "provider": "openai",
  "credential_name": "OPENAI_CRED",
  "object_list": [
    {"owner": "ADMIN", "name": "LIVELABS_USERS"},
    {"owner": "ADMIN", "name": "LIVELABS_USERS_SKILL"},
    {"owner": "ADMIN", "name": "USER_PROGRESS"},
    {"owner": "ADMIN", "name": "LIVELABS_WORKSHOPS2"}
  ]
})
```

**사용 예시:**
- 쿼리: `"Oracle Database" skill을 가진 유저는?`
- 결과: 자동 SQL 생성 및 실행으로 해당 사용자 목록 반환

### 3. 📈 사용자 스킬 진도 관리 서비스 (포트 8003)
**파일:** `MCP/rest_livelabs_user_skills_progression.py`

- **목적**: 사용자 스킬 및 워크샵 완료 추적
- **기술**: Oracle Database 23ai, MongoDB (JSON Duality Views)
- **주요 기능**:
  - 스킬 레벨 업데이트 (BEGINNER, INTERMEDIATE, ADVANCED)
  - 워크샵 완료 추적 (STARTED, COMPLETED)
  - 진도 분석 및 통계
  - 이중 데이터베이스 지원 (Oracle + MongoDB)
  - 사용자 프로필 통합 관리

**API 엔드포인트:**
- `POST /users/add` - 새 사용자 추가
- `POST /users/skills/update` - 사용자 스킬 업데이트
- `POST /users/progress/update` - 워크샵 진도 업데이트
- `GET /users/{user_id}` - 사용자 정보 조회
- `GET /health` - 서비스 상태 확인
- `GET /mcp/tools` - MCP 도구 목록

**JSON Duality Views:**
- `admin.livelabs_users_json` - 사용자 프로필
- `admin.user_skills_json` - 사용자 스킬
- `admin.user_progress_json` - 워크샵 진도
- `admin.user_profile_json` - 통합 사용자 프로필 (스킬 포함)

**데이터베이스 테이블:**
- `ADMIN.LIVELABS_USERS` - 사용자 기본 정보
- `ADMIN.LIVELABS_USERS_SKILL` - 사용자 스킬 및 경험 레벨
- `ADMIN.USER_PROGRESS` - 워크샵 완료 기록 및 평점

### 4. 🌐 Streamlit 프론트엔드
**파일:** `streamlit_livelabs_rest_app.py`

- **목적**: 다단계 AI 워크플로우를 위한 웹 인터페이스
- **기술**: Streamlit, FastMCP 클라이언트, REST API 통합
- **주요 기능**:
  - 🤖 **AI Workshop Planner**: 대화형 워크샵 추천
  - 다단계 워크플로우 실행 및 시각화
  - 실시간 단계별 진행 상황 표시
  - 완전한 한국어 인터페이스 및 응답
  - 통합 API 테스트 인터페이스
  - 포괄적인 로깅 및 디버깅
  - 서비스 상태 모니터링 및 관리

**핵심 클래스:**
- `MCPToolDiscovery` - MCP 서비스 도구 동적 발견
- `MCPServiceManager` - MCP 서비스 상태 관리
- `AIReasoner` - AI 기반 쿼리 추론 및 워크플로우 결정

**워크플로우 예시:**
```
사용자: "Python 초보자를 위한 워크샵 추천해주세요"

1. AI 추론 → 사용자 스킬 조회 (NL Query)
2. 시맨틱 검색 → Python 관련 워크샵 검색
3. LLM 응답 생성 → 개인화된 한국어 추천
```

## 🔄 다단계 AI 워크플로우

시스템은 정교한 다단계 AI 워크플로우를 구현합니다:

### 워크플로우 단계
1. **🧠 AI 추론 단계**: 사용자 쿼리 분석 및 필요한 서비스/도구 결정
2. **🔍 자연어-SQL 단계**: 사용자 스킬 및 워크샵 이력 추출
3. **🎯 시맨틱 검색 단계**: 컨텍스트 기반 관련 워크샵 검색
4. **📈 스킬 진도 단계**: 사용자 진행 상황 업데이트 (선택적)
5. **💬 AI 응답 생성**: 개인화된 한국어 추천 생성

### 동적 워크플로우 결정
- **AIReasoner 클래스**가 각 단계에서 다음 액션을 동적으로 결정
- LLM이 워크플로우 완료 여부를 판단
- 최대 5단계까지 실행 가능
- 각 단계의 결과가 다음 단계의 컨텍스트로 활용

### 워크플로우 예시
```python
# 사용자 쿼리: "내 스킬에 맞는 워크샵 추천해주세요"

Step 1: livelabs-nl-query.query_database_nl
  → 사용자 스킬 및 이력 조회
  
Step 2: livelabs-semantic-search.search_workshops  
  → 스킬 기반 워크샵 검색
  
Step 3: LLM Response Generation
  → 개인화된 한국어 추천 생성
```

각 단계는 이전 결과를 기반으로 구축되어 최종 AI 응답 생성을 위한 포괄적인 컨텍스트를 생성합니다.

## 🔧 서비스 관리

### 🚀 서비스 시작
```bash
./start_services.sh
```
- 가상환경 사용 (`venv/bin/python`)
- PID 추적을 통한 분리된 실행
- 타임스탬프가 포함된 개별 로그 파일
- 포트 충돌 감지 및 해결
- 서비스 준비 상태 검증
- 자동 의존성 확인

**시작되는 서비스:**
- 포트 8001: 시맨틱 검색 서비스
- 포트 8002: 자연어 쿼리 서비스  
- 포트 8003: 사용자 스킬 진도 관리 서비스

### 🛑 서비스 종료
```bash
./stop_services.sh
```
- 우아한 종료 (SIGTERM → SIGKILL)
- PID 기반 프로세스 관리
- 포트 기반 폴백 감지
- PID 파일 정리
- 로그 파일 보존

### 📊 모니터링
- **로그**: `logs/` 디렉토리의 타임스탬프 파일
  - `semantic_search_YYYYMMDD_HHMMSS.log`
  - `nl_query_YYYYMMDD_HHMMSS.log`
  - `user_progression_YYYYMMDD_HHMMSS.log`
- **PID**: `pids/` 디렉토리의 프로세스 추적
- **상태 확인**: 모든 서비스의 `/health` 엔드포인트
- **실시간 모니터링**: Streamlit 앱 내 서비스 상태 대시보드

## 🛠️ 기술 스택

### 🔙 백엔드
- **Python 3.13** 가상환경 지원
- **FastAPI** REST API 프레임워크
- **Oracle Database 23ai** 구조화된 데이터 및 벡터 검색
  - SELECT AI 자연어 쿼리
  - VECTOR 데이터 타입 지원
  - JSON Duality Views
- **MongoDB** 문서 저장소 (JSON 호환)
- **Oracle GenAI** LLM 작업
  - meta.llama-4-scout-17b-16e-instruct
  - cohere.command-r-plus-08-2024
- **Cohere** 임베딩 (cohere.embed-v4.0)
- **FastMCP** MCP 프로토콜 클라이언트

### 🎨 프론트엔드
- **Streamlit** 웹 인터페이스
- **커스텀 CSS** 스타일링
- **실시간 업데이트** 및 로깅
- **한국어 UI** 완전 지원
- **반응형 디자인**

### 🏗️ 인프라
- **MCP (Model Context Protocol)** JSON-RPC 서비스
- **REST APIs** HTTP 통신
- **Shell 스크립트** 프로세스 관리
- **Python logging** 모듈 로깅
- **OCI (Oracle Cloud Infrastructure)** 클라우드 서비스

### 🤖 AI/ML 스택
- **Oracle GenAI Service** - LLM 추론
- **Cohere Embeddings** - 텍스트 벡터화
- **Oracle Vector Database** - 시맨틱 검색
- **SELECT AI** - 자연어-SQL 변환
- **AIReasoner** - 커스텀 AI 추론 엔진

## ⚙️ 설정

### 🔐 환경 변수
```bash
# Oracle Database 연결 (OCI 설정)
OCI_CONFIG_FILE=~/.oci/config
OCI_CONFIG_PROFILE=DEFAULT

# MongoDB 연결 문자열
MONGO_CONNECTION_STRING=mongodb://...

# API 키 및 인증 정보
OPENAI_API_KEY=sk-...
COHERE_API_KEY=...

# 서비스 포트 및 엔드포인트
SEMANTIC_SEARCH_PORT=8001
NL_QUERY_PORT=8002
USER_PROGRESSION_PORT=8003
```

### 📦 의존성
`requirements.txt`에 통합된 모든 의존성:

**웹 프레임워크:**
- `fastapi>=0.104.0` - REST API 서버
- `streamlit>=1.28.0` - 웹 인터페이스
- `uvicorn>=0.24.0` - ASGI 서버

**데이터베이스 클라이언트:**
- `oracledb` - Oracle Database 23ai 연결
- `pymongo>=4.5.0` - MongoDB 연결
- `cx_Oracle==8.3.0` - 레거시 Oracle 지원

**AI/ML 라이브러리:**
- `oci>=2.120.0` - Oracle Cloud Infrastructure
- `numpy`, `pandas>=2.0.0` - 데이터 처리

**MCP 프로토콜:**
- `mcp>=1.0.0` - Model Context Protocol
- `fastmcp` - FastMCP 클라이언트

**유틸리티:**
- `python-dotenv==1.0.0` - 환경 변수 관리
- `psutil` - 시스템 모니터링
- `requests==2.31.0` - HTTP 클라이언트

### 📋 서비스 설정
`config/services.json`에서 MCP 서비스 설정 관리:
```json
{
  "mcpServers": {
    "livelabs-semantic-search": {
      "baseUrl": "http://localhost:8001",
      "name": "LiveLabs Semantic Search",
      "enabled": false
    }
  }
}
```

## 👨‍💻 개발 가이드라인

### 🆕 새 서비스 추가
1. `MCP/` 디렉토리에 서비스 파일 생성
2. 네이밍 규칙 준수: `rest_livelabs_*.py`
3. `start_services.sh` 및 `stop_services.sh`에 서비스 추가
4. `/health` 엔드포인트 포함
5. 적절한 로깅 및 오류 처리 추가
6. `config/services.json`에 서비스 설정 추가
7. MCP 도구 발견을 위한 `/mcp/tools` 엔드포인트 구현

### 📥 임포트 구조
- `from utils.module_name import ClassName` 사용
- MCP 서비스를 위해 프로젝트 루트를 Python 경로에 추가
- 일관된 임포트 구성 유지
- 순환 임포트 방지

### 🧪 테스트
- `test/` 디렉토리에 테스트 스크립트 작성
- 개별 서비스 및 통합 테스트 수행
- 상태 확인 엔드포인트 및 API 기능 검증
- MCP 클라이언트 연결 테스트 포함

## 🔍 문제 해결

### 🚨 일반적인 문제
1. **임포트 오류**: Python 경로와 모듈 위치 확인
2. **포트 충돌**: `lsof -i :PORT`로 포트 사용 확인
3. **데이터베이스 연결**: 인증 정보와 네트워크 접근 확인
4. **서비스 시작 실패**: `logs/` 디렉토리의 로그 파일 확인
5. **MCP 연결 오류**: 서비스 URL과 포트 상태 확인

### 📊 로그 분석
- 타임스탬프가 포함된 서비스별 로그
- 구조화된 로깅 레벨 (INFO, ERROR, DEBUG)
- API 요청/응답 로깅
- 디버깅을 위한 오류 스택 트레이스
- 성능 메트릭 및 응답 시간 추적

### 🛠️ 디버깅 도구
```bash
# 서비스 상태 확인
curl http://localhost:8001/health
curl http://localhost:8002/health  
curl http://localhost:8003/health

# 실시간 로그 모니터링
tail -f logs/semantic_search_*.log
tail -f logs/nl_query_*.log
tail -f logs/user_progression_*.log

# 프로세스 상태 확인
ps aux | grep "rest_livelabs"
```

## 🚀 향후 개선 계획

### 📈 예정된 기능
- 향상된 오류 처리 및 재시도 로직
- 성능 모니터링 및 메트릭 수집
- 자동화된 테스트 및 CI/CD 파이프라인
- Docker 컨테이너화 및 배포
- 로드 밸런싱 및 스케일링 지원
- 캐싱 메커니즘 구현

### 🏗️ 아키텍처 개선
- 서비스 디스커버리 메커니즘 구현
- 중앙화된 설정 관리 시스템
- 통합 로깅 및 모니터링 플랫폼
- API 버전 관리 및 자동 문서화
- 보안 강화 및 인증/인가 시스템
- 마이크로서비스 오케스트레이션

### 🔒 보안 및 운영
- JWT 기반 인증 시스템
- API 레이트 리미팅
- 데이터 암호화 및 보안 감사
- 백업 및 재해 복구 계획
- 모니터링 대시보드 및 알림 시스템
